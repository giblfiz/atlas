<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html> <head>
<title>Property Tracker</title>
<script type="text/javascript" src="web3.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

<script type="text/javascript">
$( document ).ready(function(){

    var PTabi = [{"constant":false,"inputs":[{"name":"_region_hash","type":"bytes32"},{"name":"_new_owner","type":"address"},{"name":"_action_id","type":"uint8"}],"name":"SignPending","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_region_hash","type":"bytes32"},{"name":"_new_owner","type":"address"},{"name":"_action_id","type":"uint8"}],"name":"pendingExecuted","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_region_hash","type":"bytes32"},{"name":"_new_owner","type":"address"},{"name":"_new_owner_name","type":"string"}],"name":"TransferRegion","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_new_officer","type":"address"},{"name":"_officer_type","type":"uint8"}],"name":"CreateOfficer","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_lat","type":"uint8"},{"name":"_lng","type":"uint8"}],"name":"GetRegionContainingLatLng","outputs":[{"name":"region","type":"bytes32"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_ul_lat","type":"uint8"},{"name":"_ul_lng","type":"uint8"},{"name":"_lr_lat","type":"uint8"},{"name":"_lr_lng","type":"uint8"},{"name":"_new_owner","type":"address"},{"name":"_street_address","type":"string"}],"name":"CreateRegion","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_owner","type":"address"}],"name":"GetRegionByOwner","outputs":[{"name":"","type":"bytes32"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"region_hash_list","outputs":[{"name":"","type":"bytes32"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_region_hash","type":"bytes32"}],"name":"DisolveRegion","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_new_officer","type":"address"}],"name":"RemoveOfficer","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"","type":"bytes32"}],"name":"pending_actions","outputs":[{"name":"region_hash","type":"bytes32"},{"name":"action_id","type":"uint8"},{"name":"owner_signature","type":"address"},{"name":"local_signature","type":"address"},{"name":"federal_signature","type":"address"},{"name":"judicial_signature","type":"address"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"","type":"bytes32"}],"name":"region_record","outputs":[{"name":"ul_lat","type":"uint8"},{"name":"ul_lng","type":"uint8"},{"name":"lr_lat","type":"uint8"},{"name":"lr_lng","type":"uint8"},{"name":"owner_name","type":"string"},{"name":"street_address","type":"string"},{"name":"owner","type":"address"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"officer","outputs":[{"name":"","type":"uint8"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_region_hash","type":"bytes32"},{"name":"_new_owner","type":"address"},{"name":"_action_id","type":"uint8"}],"name":"isPendingOwnerSigned","outputs":[{"name":"","type":"bool"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_region_hash","type":"bytes32"},{"name":"_new_owner","type":"address"},{"name":"_action_id","type":"uint8"}],"name":"isPendingFormalSigned","outputs":[{"name":"","type":"bool"}],"payable":false,"type":"function"},{"inputs":[{"name":"_judicial","type":"address"},{"name":"_local","type":"address"}],"payable":false,"type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"code","type":"uint8"}],"name":"debug","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"pa_hash","type":"bytes32"}],"name":"pendingAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"_region_hash","type":"bytes32"},{"indexed":false,"name":"_new_owner","type":"address"},{"indexed":true,"name":"_action_id","type":"uint8"},{"indexed":false,"name":"owner","type":"address"},{"indexed":false,"name":"judicial","type":"address"},{"indexed":false,"name":"federal","type":"address"},{"indexed":true,"name":"local","type":"address"}],"name":"ActionExecuted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"region_hash","type":"bytes32"},{"indexed":false,"name":"judicial","type":"address"},{"indexed":false,"name":"federal","type":"address"},{"indexed":false,"name":"local","type":"address"},{"indexed":false,"name":"owner","type":"address"}],"name":"CreateRegionExecuted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"_region_hash","type":"bytes32"},{"indexed":false,"name":"_ul_lat","type":"uint8"},{"indexed":false,"name":"_ul_lng","type":"uint8"},{"indexed":false,"name":"_lr_lat","type":"uint8"},{"indexed":false,"name":"_lr_lng","type":"uint8"},{"indexed":false,"name":"street_address","type":"string"}],"name":"DissolvedRegion","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"_region_hash","type":"bytes32"},{"indexed":true,"name":"_owner_name","type":"string"}],"name":"TransferedRegion","type":"event"}];
    var Web3 = require('web3');

  // Checking if Web3 has been injected by the browser (Mist/MetaMask)
  if (typeof web3 !== 'undefined') {
    // Use Mist/MetaMask's provider
    web3 = new Web3(web3.currentProvider);
  } else {
    var web3 = new Web3();
    console.log('No web3? You should consider trying MetaMask!')
    // fallback - use your fallback strategy (local node / hosted node + in-dapp id mgmt / fail)
    web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
  }


//this is lifted from some dudes comment
//
  function solSha3 (...args) {
      args = args.map(arg => {
          if (typeof arg === 'string') {
              if (arg.substring(0, 2) === '0x') {
                  return arg.slice(2)
              } else {
                  return web3.toHex(arg).slice(2)
              }
          }

          if (typeof arg === 'number') {
              return leftPad((arg).toString(16), 64, 0)
          } else {
            return ''
          }
      })

      args = args.join('')

      return '0x' + web3.sha3(args, { encoding: 'hex' })
  }

function getPT(){
      tokenAddress = $("#tokenAddress").val();
      token = web3.eth.contract(PTabi).at(tokenAddress);
      return token;
}

function populateUserAddressOptions(){
  web3.eth.accounts.forEach(function(addr){
    $('#me').append($('<option>', {
      value: addr,
      text: addr
    }));
  })
}

function populateParcelHashOptions(){
  for(i=0;i<10;i++){
    if(getPT().region_hash_list(i) != "0x"){
      $('#parcel_hash').append($('<option>', {
        value: getPT().region_hash_list(i),
        text: getPT().region_record(getPT().region_hash_list(i))[5]
      }));
    }
  }
}


function updateValues() {
      me = $("#me").val();
      balance = web3.eth.getBalance(me).toNumber();
      $("#balance").text(balance);

      officer_type_number = getPT().officer(me);
      if(officer_type_number == 1){
        ot = "Notary (local)";
      } else if(officer_type_number == 2){
        ot = "Federal";
      } else if(officer_type_number == 3){
        ot = "Judicial";
      } else if(officer_type_number == 0){
        if(getPT().region_record($("#parcel_hash").val())[6] == me){
          ot = "Parcel Owner";
        } else {
          ot = "Not an officer";
        }
      }
      $("#officer_type").text(
        " " + ot
      )
}

function send(){
  getPT().TransferRegion.sendTransaction(
    $("#parcel_hash").val(),
    $("#new_owner_addr").val(),
    $("#new_owner_name").val(),
    {
      from:$("#me").val(),
      gas:1000000
    }
  )
  $("#status").text("waiting for block...");
  count = 1;
  web3.eth.filter('latest').watch(function() {
    // console.log(
    //   getPT().pending_actions(solSha3($("#parcel_hash").val(),
    //       $("#new_owner_addr").val(),
    //       19))
    // );

    updateValues()
    $("#status").text("Blocks mined " + count++);
  })
}

function createParcel(ul_lat, ul_lng, lr_lat, lr_lng, street_address){
  getPT().CreateRegion.sendTransaction(
    ul_lat, ul_lng,
    lr_lat, lr_lng,
    $("#new_owner_addr").val(),
    99999,
    {
      from:$("#me").val(),
      gas:1000000
    }
  )

}

$("#me").change(function(){
  populateUserAddressOptions();
  populateParcelHashOptions();
  updateValues();
});

$("#send").click(function(){
  send();
});

$("#create").click(function(){
  createParcel($("#ul_lat").val(),
          $("#ul_lng").val(),
          $("#lr_lat").val(),
          $("#lr_lng").val(),
          $("#street_address").val()
          );
});

//lets set it all up:
populateUserAddressOptions();
populateParcelHashOptions();
});

</script>

</head>

<body>
<h1>Token Interface:</h1>

<input type=string size= 46 value="0x4c41fe20e50f12cc9ff686dc0c57f607f1a4532b"
name = "Token Address" id ="tokenAddress" /><label>Contract Address (You probably don't want to change this)
</label>
<br/>

<select name = "My Account" id ="me" />
  <option selected value=0x0>None found, Do you have a GETH node running?</option>
</select>
<label>My Address
</label>

<hr/>

<h2> Transfer a Parcel </h2>

<select name = "Real Estate Parcel Hash" id ="parcel_hash" />
  <option selected value=0x0>--</option>
</select>
<label>Parcel Hash (dropdown UI only makes sense when there are few parcels)</label>
<br/>

<input type=string size = 46 value="0x53939de4ee95e908871644c47eff301857140bd7"
name = "target address" id ="new_owner_addr" />
<label>
  New Owner Address (later should be a QR reader)
</label>
<br/>


<input type=string size = 46 value="Dr. SuchandSuch"
name = "target name" id ="new_owner_name" />
<label>
  New Owner Name
</label>
<br/>

<input type = button value = "Send" id="send" />


<hr/>
<h2> Create a Parcel </h2>
UPPER LEFT lat/lng:
<input type=string  value="1000" name = "ul_lat" id ="ul_lat" />/
<input type=string  value="2000" name = "ul_lng" id ="ul_lng" />
<br/>

LOWER RIGHT lat/lng:
<input type=string  value="5000" name = "lr_lat" id ="ul_lat" />/
<input type=string  value="6000" name = "lr_lng" id ="ul_lng" />
<br/>

<input type=string  value="Somewhere Lovely!" name = "street_address" id ="street_address" />

<input type= button value="create parcel" id ="create" />


<hr/>
<h2>Dynamic status Information</h2>
<div>Status:<span id="status">...</span></div>
<div>Balance[Wei]:<span id="balance">...</span></div>
<div>Officer type?<span id="officer_type">...</span></div>

<br/>
<input type = button value = "UPDATE!" id="update""/>

<hr>
<address></address>
</body> </html>
